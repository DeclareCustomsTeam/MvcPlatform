@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="/js/Extjs42/resources/css/ext-all-gray.css" rel="stylesheet" type="text/css" />
<script src="/js/Extjs42/bootstrap.js" type="text/javascript"></script>

<script src="/js/pan.js" type="text/javascript"></script>
<script src="~/Views/EnterpriseOrder/createwinjs.js"></script>
<script src="~/js/commondata.js"></script>

<script type="text/javascript">
    var gridpanel, store_busitype;
    var common_data_sbgq = [], common_data_sbfs = [];
    Ext.onReady(function () {

        //查询区域
        initSearch();
        store_busitype = Ext.create('Ext.data.JsonStore', {
            fields: ['CODE', 'NAME'],
            data: common_data_busitype
        });
        var store = Ext.create('Ext.data.JsonStore', {
            fields: ['ID', 'FILERECEVIEUNITCODE', 'FILERECEVIEUNITNAME', 'FILEDECLAREUNITCODE', 'FILEDECLAREUNITNAME', 'BUSITYPEID',
                'CUSTOMDISTRICTCODE', 'CUSTOMDISTRICTNAME', 'REPWAYID', 'STATUS', 'CODE', 'CREATEID', 'CREATENAME', 'CREATETIME', 'ASSOCIATENO',
                'ORDERCODE', 'ENTERPRISECODE', 'ENTERPRISENAME', 'ACCEPTID', 'ACCEPTNAME', 'SUBMITTIME', 'ACCEPTTIME', 'REMARK'],
            pageSize: 20,
            proxy: {
                type: 'ajax',
                url: '/EnterpriseOrder/LoadProcess',
                reader: {
                    root: 'rows',
                    type: 'json',
                    totalProperty: 'total'
                }
            },
            autoLoad: true,
            listeners: {
                beforeload: function () {
                    store.getProxy().extraParams = {
                        FILERECEVIEUNIT: Ext.getCmp('s_field_FILERECEVIEUNIT').getValue(), STATUS: Ext.getCmp("s_combo_status").getValue(),
                        CODE: Ext.getCmp('field_CODE').getValue(),
                        STARTDATE: Ext.Date.format(Ext.getCmp("start_date").getValue(), 'Y-m-d H:i:s'),
                        ENDDATE: Ext.Date.format(Ext.getCmp("end_date").getValue(), 'Y-m-d H:i:s')
                    }
                }
            }
        })
        var pgbar = Ext.create('Ext.toolbar.Paging', {
            id: 'pgbar',
            displayMsg: '显示 {0} - {1} 条,共计 {2} 条',
            store: store,
            displayInfo: true
        })
        gridpanel = Ext.create('Ext.grid.Panel', {
            renderTo: "appConId",
            store: store,
            height: 500,
            selModel: { selType: 'checkboxmodel' },
            bbar: pgbar,
            enableColumnHide: false,
            columns: [
            { xtype: 'rownumberer', width: 35 },
            { header: 'ID', dataIndex: 'ID', hidden: true, locked: true },
            { header: '委托编号', dataIndex: 'CODE', width: 130, locked: true },
            { header: '委托企业', dataIndex: 'ENTERPRISENAME', width: 150, locked: true },
            { header: '申报方式', dataIndex: 'REPWAYID', width: 100, locked: true },
            { header: '申报关区', dataIndex: 'CUSTOMDISTRICTNAME', width: 100, locked: true },
            { header: '业务类型', dataIndex: 'BUSITYPEID', width: 100, locked: true, renderer: render },
            { header: '文件接收单位', dataIndex: 'FILERECEVIEUNITNAME', width: 200 },
            { header: '文件申报单位', dataIndex: 'FILEDECLAREUNITNAME', width: 180, locked: true },
            { header: '状态', dataIndex: 'STATUS', width: 70, renderer: render, locked: true },
            { header: '提交时间', dataIndex: 'SUBMITTIME', width: 130 },
            { header: '受理时间', dataIndex: 'ACCEPTTIME', width: 130 },
            { header: '受理人', dataIndex: 'ACCEPTNAME', width: 100 },
            { header: '备注', dataIndex: 'REMARK', width: 150 }
            ],
            listeners:
            {
                'itemdblclick': function (view, record, item, index, e) {
                    var busitype = "";
                    switch (record.get("BUSITYPEID")) {
                        case "10":
                            busitype = "空运出口"; break;
                        case "11":
                            busitype = "空运进口"; break;
                        case "20":
                            busitype = "海运出口"; break;
                        case "21":
                            busitype = "海运进口"; break;
                        case "30":
                            busitype = "陆运出口"; break;
                        case "31":
                            busitype = "陆运进口"; break;
                        case "40":
                        case "41":
                            busitype = "国内"; break;
                        case "50":
                        case "51":
                            busitype = "特殊区域"; break;
                    }
                    Ext.Ajax.request({
                        url: "/Common/Ini_Base_Data",
                        params: { busitype: busitype },
                        success: function (response, opts) {
                            var commondata = Ext.decode(response.responseText);
                            common_data_sbgq = commondata.sbgq;//申报关区   for win 窗口使用
                            common_data_sbfs = commondata.sbfs;//申报方式
                            addwin(record.get("ID"), record.get("BUSITYPEID"));
                        }
                    })
                }
            },
            viewConfig: {
                enableTextSelection: true
            },
            forceFit: true
        })

    });

    function initSearch() {
        var s_field_FILERECEVIEUNIT = Ext.create('Ext.form.field.Text', {  //文件接收单位
            id: 's_field_FILERECEVIEUNIT',
            name: 'FILERECEVIEUNIT',
            margin: 0,
            flex: .85
        })

        var cont_wjjsdw = Ext.create('Ext.form.FieldContainer', {
            fieldLabel: '接收单位',
            layout: 'hbox',
            items: [s_field_FILERECEVIEUNIT, {
                xtype: 'button', id: 's_btn_filerecevieunit', handler: function () { bgsbdw_win(s_field_FILERECEVIEUNIT); },
                text: '<span class="glyphicon glyphicon-search"></span>', flex: .15, margin: 0
            }]
        })
        var store_status = Ext.create('Ext.data.JsonStore', {
            fields: ['CODE', 'NAME'],
            data: [{ CODE: '10', NAME: '未受理' }, { CODE: '15', NAME: '已受理' }]
        });
        var s_combo_status = Ext.create('Ext.form.field.ComboBox', {
            id: 's_combo_status',
            editable: false,
            store: store_status,
            fieldLabel: '委托状态',
            value: '10',
            displayField: 'NAME',
            name: 'STATUS',
            valueField: 'CODE',
            triggerAction: 'all',
            queryMode: 'local'
        });
        //企业编号
        var field_CODE = Ext.create('Ext.form.field.Text', {
            id: 'field_CODE',
            fieldLabel: '企业编号',
            name: 'CODE'
        });
        var start_date = Ext.create('Ext.form.field.Date', {
            id: 'start_date',
            format: 'Y-m-d',
            fieldLabel: '提交日期从'
        })
        var end_date = Ext.create('Ext.form.field.Date', {
            id: 'end_date',
            fieldLabel: '到',
            format: 'Y-m-d'
        })
        var formpanel = Ext.create('Ext.form.Panel', {
            id: 'formpanel',
            renderTo: 'div_form',
            fieldDefaults: {
                margin: '5',
                columnWidth: 0.20,
                labelWidth: 70
            },
            items: [
            { layout: 'column', border: 0, margin: '5 0 0 0', items: [cont_wjjsdw, s_combo_status, field_CODE, start_date, end_date] }
            ]
        });

    }

    function Select() {
        Ext.getCmp('pgbar').moveFirst();
    }

    function render(value, cellmeta, record, rowIndex, columnIndex, store) {
        var rtn = "";
        var dataindex = cellmeta.column.dataIndex;
        switch (dataindex) {
            case "STATUS":
                rtn = value == '10' ? '未受理' : '已受理';
                break;
            case "BUSITYPEID":
                var rec = store_busitype.findRecord('CODE', value);
                rtn = rec.get("NAME");
                break;
        }
        return rtn;
    }

    function Reset() {
        Ext.each(Ext.getCmp('formpanel').getForm().getFields().items, function (field) {
            field.reset();
        });
    }

    function SignProcess() {
        var recs = gridpanel.getSelectionModel().getSelection();
        if (recs.length == 0) {
            Ext.MessageBox.alert('提示', '请选择需要操作的记录！');
            return;
        }
        var ids = "";
        for (var i = 0; i < recs.length; i++) {
            ids += recs[i].data.ID + ',';
        }
        Ext.Ajax.request({
            url: "/EnterpriseOrder/SignProcess",
            params: { ids: ids },
            success: function (response, option) {
                var data = Ext.decode(response.responseText);
                if (data.success) {
                    Ext.MessageBox.alert("提示", "受理成功!", function () {
                        gridpanel.store.load();
                    });
                }
                else {
                    Ext.MessageBox.alert("提示", "受理失败!");
                }
            }
        });
    }

</script>

<div class="container">
    <div id="div_form" style="width:100%;"></div>
    <div>
        <div class="btn-group" role="group">
            <button onclick="SignProcess()" type="button" class="btn btn-primary btn-sm"><i class="fa fa-check-square"></i>&nbsp;直接受理</button>
            <button type="button" class="btn btn-primary btn-sm"><i class="fa fa-sign-in"></i>&nbsp;转订单受理</button>
        </div>
        <div class="btn-group fr" role="group">
            <button onclick="Select()" class="btn btn-primary btn-sm"><i class="fa fa-search"></i>&nbsp;查询</button>
            <button onclick="Reset()" type="button" class="btn btn-primary btn-sm"><i class="fa fa-refresh"></i>&nbsp;重置</button>
        </div>
    </div>
    <div id="appConId" style="width:100%"></div>
</div>

